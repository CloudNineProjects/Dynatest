<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PBO Dynamax Helper</title>

<!-- PapaParse for robust CSV parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
:root{
  --bg-light:#666769; --bg-dark:#1A252C;
  --card-light:#026503; --card-dark:#023804;
  --btn-bg:#F0F0F0; --btn-text:#000;
}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,Arial,sans-serif;margin:0;background:var(--bg-light);color:#fff;min-height:100vh}
.dark-mode{background:var(--bg-dark);color:#fff}
.container{max-width:1100px;margin:72px auto;padding:20px}
.header{display:flex;align-items:center;gap:12px;justify-content:center}
h1{margin:0 0 14px 0;font-size:1.4rem;text-align:center;color:#fff}
.toggle-container{position:fixed;top:14px;right:18px;z-index:1200}
.toggle-btn{background:var(--btn-bg);color:var(--btn-text);border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
.dark-mode .toggle-btn{background:#222;color:#fff}

/* Loading screen */
.loading-screen{height:100vh;display:flex;align-items:center;justify-content:center;background:var(--bg-light);position:fixed;inset:0;z-index:2000}
.dark-mode .loading-screen{background:var(--bg-dark)}
.load-box{background:var(--card-light);padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.25);text-align:center}
.dark-mode .load-box{background:var(--card-dark)}
.load-img{width:180px;height:180px;object-fit:cover;border-radius:12px;display:block;margin:6px auto}
.load-btn{padding:10px 18px;border-radius:10px;border:none;background:var(--btn-bg);color:var(--btn-text);cursor:pointer;font-weight:700}
.progress{margin-top:12px;font-size:0.95rem;color:rgba(255,255,255,0.9)}

/* cards */
.card{background:var(--card-light);padding:16px;border-radius:12px;margin-bottom:18px}
.dark-mode .card{background:var(--card-dark)}
label{display:block;margin-bottom:6px;font-size:0.95rem}
select,input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);margin-bottom:8px;background:transparent;color:inherit}
.row{display:flex;gap:12px}
.row>div{flex:1}
.small-btn{padding:8px 12px;border-radius:8px;border:none;background:var(--btn-bg);color:var(--btn-text);cursor:pointer;font-weight:600}
.small-btn:disabled{opacity:0.5;cursor:not-allowed}
.note{font-size:0.9rem;color:rgba(255,255,255,0.9);margin-top:8px}

/* table wrapper */
.table-wrap{overflow:auto;margin-top:10px;background:#fff;color:#000;border-radius:8px;padding:8px}
.dark-mode .table-wrap{background:#071418;color:#fff}
table{border-collapse:collapse;width:100%}
th,td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.08);text-align:left;vertical-align:top}
th{background:rgba(255,255,255,0.12);font-weight:700}

/* preserve content formatting */
.prewrap{white-space:pre-wrap;word-break:break-word}

/* responsive */
@media (max-width:760px){.row{flex-direction:column}}
.footer{margin-top:30px;text-align:center;color:rgba(255,255,255,0.8);font-weight:600}
</style>
</head>
<body>

<!-- Toggle -->
<div class="toggle-container">
  <button id="toggleMode" class="toggle-btn">ðŸŒ™ Dark Mode</button>
</div>

<!-- Loading screen -->
<div id="loadingScreen" class="loading-screen">
  <div class="load-box">
    <h2>PBO Dynamax Helper</h2>
    <!-- your usual image -->
    <img class="load-img" src="https://i.imgur.com/XZcfQzw.png" alt="CloudNine">
    <p style="margin:8px 0 12px 0">Click to load data from the published sheets (CSV)</p>
    <button id="startLoad" class="load-btn">Load Data</button>
    <div id="loadProgress" class="progress" style="display:none"></div>
    <div style="font-size:0.85rem;margin-top:8px;color:rgba(255,255,255,0.8)">Sheets must be published and publicly accessible.</div>
  </div>
</div>

<!-- App -->
<div id="app" class="container" style="display:none">
  <div class="header"><h1>PBO Dynamax Helper</h1></div>

  <!-- Card 1: Dynamax Info -->
  <div class="card" id="card-info">
    <h3>Dynamax Info</h3>
    <label>Type (column A)</label>
    <select id="infoTypeSelect"><option value="">Select Type</option></select>
    <div style="margin-top:8px">
      <button id="infoReset" class="small-btn">Reset</button>
    </div>
    <div id="infoResult" class="note prewrap" style="margin-top:10px"></div>
  </div>

  <!-- Card 2: Dynamax Database -->
  <div class="card" id="card-db">
    <h3>Dynamax Database</h3>
    <label>Group (column A)</label>
    <select id="dbGroupSelect"><option value="">Select Group</option></select>
    <div style="margin-top:8px">
      <button id="dbReset" class="small-btn">Reset</button>
    </div>
    <div id="dbResult" class="table-wrap" style="display:none"></div>
  </div>

  <!-- Card 3: Type Effectiveness Checker -->
  <div class="card" id="card-type">
    <h3>Type Effectiveness Checker</h3>

    <div style="margin-bottom:10px">
      <label>Raid Type(s) â€” choose up to 2 (defender)</label>
      <div class="row">
        <div><select id="raidType1"><option value="">(none)</option></select></div>
        <div><select id="raidType2"><option value="">(none)</option></select></div>
      </div>
      <div style="margin-top:8px"><button id="findAttackers" class="small-btn">Find Attackers (â‰¥2Ã—)</button> <button id="resetRaid" class="small-btn">Reset</button></div>
      <div id="attackCandidates" class="note" style="margin-top:8px"></div>
    </div>

    <hr style="border:none;height:10px">

    <div style="margin-top:10px">
      <label>Movepool Types â€” choose up to 4 (attack types)</label>
      <div class="row">
        <div><select id="move1"><option value="">(none)</option></select></div>
        <div><select id="move2"><option value="">(none)</option></select></div>
        <div><select id="move3"><option value="">(none)</option></select></div>
        <div><select id="move4"><option value="">(none)</option></select></div>
      </div>
      <div style="margin-top:8px"><button id="evaluateVuln" class="small-btn">Evaluate Vulnerability</button> <button id="resetMoves" class="small-btn">Reset</button></div>
      <div id="vulnResult" class="table-wrap" style="display:none;margin-top:10px"></div>
    </div>
  </div>

  <div class="footer">@CloudNine</div>
</div>

<script>
/* ---------- Sheet URLs ---------- */
const SHEET_INFO = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRKBJf3BXL7kqLIu8WAZCiFIBqNTMVvWCmkRA2kVoC30QskuIRkxwUKJJnrHKh2Y8I18iZ0p068wRD2/pub?output=csv";
const SHEET_DB   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRGq_ta_VKuhpNif51aoWSm2XKE04CHREcDqGObDZnBQ0kK3Yo-_Bz7i7u1oP1Xv9pRm0-xN7dDgyiT/pub?output=csv";
const SHEET_TYPES= "https://docs.google.com/spreadsheets/d/e/2PACX-1vQUYm_GBIYmou5lzjHIeXmz9GlP0d4_z3g6Jxrpof_DvIBFdOh8bL4dNF8v4T2Vn5sseu8zOhRzP74O/pub?output=csv";

/* ---------- state ---------- */
let infoData = [];  // array of objects (header:true)
let dbData = [];    // array of objects (header:true)
let typesHeader = []; // header array for type chart (first row)
let typesRows = [];   // rows array for type chart (each row is array)

/* ---------- UI refs ---------- */
const loadingScreen = document.getElementById("loadingScreen");
const startLoadBtn = document.getElementById("startLoad");
const loadProgress = document.getElementById("loadProgress");
const app = document.getElementById("app");
const toggleMode = document.getElementById("toggleMode");

/* ---------- toggle dark/light ---------- */
toggleMode.addEventListener("click", ()=>{
  document.body.classList.toggle("dark-mode");
  toggleMode.textContent = document.body.classList.contains("dark-mode") ? "â˜€ï¸ Light Mode" : "ðŸŒ™ Dark Mode";
});

/* ---------- load data ---------- */
startLoadBtn.addEventListener("click", ()=>{
  loadProgress.style.display = "block";
  loadProgress.textContent = "Downloading sheetsâ€¦";

  const p1 = new Promise((res,rej)=> Papa.parse(SHEET_INFO, {download:true,header:true,skipEmptyLines:true,complete:(r)=>res(r.data),error:err=>rej(err)}));
  const p2 = new Promise((res,rej)=> Papa.parse(SHEET_DB,   {download:true,header:true,skipEmptyLines:true,complete:(r)=>res(r.data),error:err=>rej(err)}));
  const p3 = new Promise((res,rej)=> Papa.parse(SHEET_TYPES,{download:true,header:false,skipEmptyLines:true,complete:(r)=>res(r.data),error:err=>rej(err)}));

  Promise.all([p1,p2,p3]).then(results=>{
    infoData = results[0];
    dbData   = results[1];
    const rawTypes = results[2];

    // normalize types table
    if(rawTypes && rawTypes.length>0){
      typesHeader = rawTypes[0].map(c => (c||"").trim());
      typesRows = rawTypes.slice(1).map(r => r.map(c => (c||"").trim()));
    } else {
      typesHeader = []; typesRows = [];
    }

    populateInfo();
    populateDb();
    populateTypeSelects();

    loadingScreen.style.display = "none";
    app.style.display = "block";
  }).catch(err=>{
    console.error("Load error",err);
    loadProgress.textContent = "Loading failed â€” check sheet URLs and that they are published.";
  });
});

/* ---------- Card 1: Dynamax Info ---------- */
const infoTypeSelect = document.getElementById("infoTypeSelect");
const infoResult = document.getElementById("infoResult");
document.getElementById("infoReset").addEventListener("click", ()=>{ infoTypeSelect.value=""; infoResult.innerHTML=""; });

function populateInfo(){
  infoTypeSelect.innerHTML = '<option value="">Select Type</option>';
  if(!infoData || !infoData.length) return;
  // Determine first two column keys dynamically
  const keys = Object.keys(infoData[0]);
  const colA = keys[0], colB = keys[1] || null;
  const set = new Set();
  for(const r of infoData){ if(r[colA]) set.add((r[colA]||"").trim()); }
  const arr = Array.from(set).sort((a,b)=>a.localeCompare(b));
  arr.forEach(v=> { const o = document.createElement('option'); o.value=v; o.textContent=v; infoTypeSelect.appendChild(o); });

  infoTypeSelect.onchange = ()=>{
    const val = infoTypeSelect.value;
    if(!val){ infoResult.innerHTML = ""; return; }
    const hits = infoData.filter(r => ((r[colA]||"").trim().toLowerCase() === val.toLowerCase()));
    if(!hits.length){ infoResult.innerHTML = "<div class='note'>No description found.</div>"; return; }
    // show column B of all hits joined with blank line, preserve formatting
    const texts = hits.map(h => (colB ? (h[colB]||"") : "").trim()).filter(Boolean);
    infoResult.innerHTML = texts.length ? `<div class="prewrap" style="background:rgba(0,0,0,0.12);padding:10px;border-radius:8px;color:#fff">${escapeHtml(texts.join("\n\n"))}</div>` : "<div class='note'>No description available.</div>";
  };
}

/* ---------- Card 2: Dynamax Database ---------- */
const dbGroupSelect = document.getElementById("dbGroupSelect");
const dbResult = document.getElementById("dbResult");
document.getElementById("dbReset").addEventListener("click", ()=>{ dbGroupSelect.value=""; dbResult.style.display="none"; dbResult.innerHTML=""; });

function populateDb(){
  dbGroupSelect.innerHTML = '<option value="">Select Group</option>';
  if(!dbData || !dbData.length) return;
  const keys = Object.keys(dbData[0]);
  const colA = keys[0];
  const uniq = Array.from(new Set(dbData.map(r=> (r[colA]||"").trim()))).sort((a,b)=>a.localeCompare(b));
  uniq.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; dbGroupSelect.appendChild(o); });

  dbGroupSelect.onchange = ()=>{
    const val = dbGroupSelect.value;
    if(!val){ dbResult.style.display="none"; dbResult.innerHTML=""; return; }
    const rows = dbData.filter(r => ((r[colA]||"").trim() === val));
    if(!rows.length){ dbResult.innerHTML = "<div class='note'>No rows found.</div>"; dbResult.style.display="block"; return; }
    // show columns A..I (or available columns)
    const cols = Object.keys(rows[0]).slice(0,9);
    let html = "<table><thead><tr>";
    cols.forEach(c=> html += `<th>${escapeHtml(c)}</th>`);
    html += "</tr></thead><tbody>";
    rows.forEach(r=>{
      html += "<tr>";
      cols.forEach(c=>{
        const cell = r[c] || "";
        // preserve newlines and dashes using pre-wrap
        html += `<td class="prewrap">${escapeHtml(cell)}</td>`;
      });
      html += "</tr>";
    });
    html += "</tbody></table>";
    dbResult.innerHTML = html;
    dbResult.style.display = "block";
  };
}

/* ---------- Card 3: Type Effectiveness ---------- */
/* parse typesHeader (array) and typesRows (array of arrays)
   header: [ "Type","Normal","Fire",... ]  (first column label then defender types)
   typesRows: [ ["Normal","1","1",...], ["Fighting","2","0.5",...] ] where each row[0] is attack type name
*/

const raidType1 = document.getElementById("raidType1");
const raidType2 = document.getElementById("raidType2");
const findAttackersBtn = document.getElementById("findAttackers");
const resetRaidBtn = document.getElementById("resetRaid");
const attackCandidatesDiv = document.getElementById("attackCandidates");

const moveSelects = [document.getElementById("move1"),document.getElementById("move2"),document.getElementById("move3"),document.getElementById("move4")];
const evaluateVulnBtn = document.getElementById("evaluateVuln");
const resetMovesBtn = document.getElementById("resetMoves");
const vulnResultDiv = document.getElementById("vulnResult");

function populateTypeSelects(){
  // clear first
  [raidType1,raidType2,...moveSelects].forEach(s=>{
    if(!s) return;
    s.innerHTML = '<option value="">(none)</option>';
  });
  if(!typesHeader || typesHeader.length < 2) return;
  // defender type names are header[1..]
  const defenderTypes = typesHeader.slice(1);
  defenderTypes.forEach(t=>{
    // append to raid selects
    const o1 = document.createElement('option'); o1.value = t; o1.textContent = t;
    raidType1.appendChild(o1.cloneNode(true));
    raidType2.appendChild(o1.cloneNode(true));
    // append to move selects as well (attack types are row[0], but moves are by type too; we'll also add attack type names later)
    moveSelects.forEach(s => s.appendChild(o1.cloneNode(true)));
  });
  // Add attack type names (rows' first col) to move selects as additional options if not present
  typesRows.forEach(r=>{
    const atk = (r[0]||"").trim();
    if(!atk) return;
    moveSelects.forEach(s=>{
      // don't duplicate (some types may already be present)
      if(!Array.from(s.options).some(opt=>opt.value.toLowerCase()===atk.toLowerCase())){
        const o=document.createElement('option'); o.value=atk; o.textContent=atk;
        s.appendChild(o);
      }
    });
  });
}

/* utility: find defender column index by type name (returns index in header/row; header[0] is label)
   returns numeric index (0-based) matching typesHeader; for defender columns, it's >=1
*/
function defenderColIndex(typeName){
  if(!typesHeader) return -1;
  for(let i=1;i<typesHeader.length;i++){
    if((typesHeader[i]||"").trim().toLowerCase() === (typeName||"").trim().toLowerCase()) return i;
  }
  return -1;
}

/* utility: find attack row by attackType name (match row[0]) */
function findAttackRow(attackType){
  if(!typesRows) return null;
  for(const r of typesRows){
    if(((r[0]||"").trim().toLowerCase()) === (attackType||"").trim().toLowerCase()) return r;
  }
  return null;
}

/* compute multiplier of attackRow vs defender types array */
function computeMultiplierForAttackRow(attackRow, defenderTypes){
  // attackRow is array; defenderTypes is array of type names (1 or 2)
  if(!attackRow) return 1;
  let mult = 1;
  for(const d of defenderTypes){
    const col = defenderColIndex(d);
    if(col < 1) return null; // missing column
    const cell = (attackRow[col]||"").trim();
    const num = Number(cell);
    if(Number.isNaN(num)) return null;
    mult *= num;
  }
  return mult;
}

/* when findAttackers pressed */
let currentCandidates = []; // list of attack types (strings)
findAttackersBtn.addEventListener("click", ()=>{
  attackCandidatesDiv.innerHTML = "";
  vulnResultDiv.style.display = "none"; vulnResultDiv.innerHTML = "";
  currentCandidates = [];

  const d1 = raidType1.value;
  const d2 = raidType2.value;
  if(!d1 && !d2){ attackCandidatesDiv.textContent = "Select at least one Raid Type (defender)."; return; }
  const defenders = [];
  if(d1) defenders.push(d1);
  if(d2) defenders.push(d2);

  // Loop through each attack row (typesRows). For each, compute per-defender-type cell values and multiplier.
  const matches = [];
  for(const r of typesRows){
    const atkName = (r[0]||"").trim();
    if(!atkName) continue;
    // for each defender type, get the cell value
    let ok = true;
    let mult = 1;
    for(const d of defenders){
      const col = defenderColIndex(d);
      if(col < 1){ ok = false; break; } // missing defender column
      const cell = (r[col]||"").trim();
      const num = Number(cell);
      if(Number.isNaN(num)){ ok=false; break; }
      if(num === 0){ ok = false; break; } // if any sub-type is 0 -> negated
      mult *= num;
    }
    if(!ok) continue;
    // consider it candidate if mult >= 2 (as requested)
    if(mult >= 2){
      matches.push({ attack: atkName, multiplier: mult });
    }
  }

  if(!matches.length){
    attackCandidatesDiv.textContent = "No attacker types found that deal >=2Ã— to the selected raid type(s).";
    currentCandidates = [];
    return;
  }
  // sort by multiplier desc then name
  matches.sort((a,b)=> b.multiplier - a.multiplier || a.attack.localeCompare(b.attack));
  currentCandidates = matches.map(m=>m.attack);
  // show list with multiplier
  attackCandidatesDiv.innerHTML = "<strong>Candidates:</strong> " + matches.map(m=>`${escapeHtml(m.attack)} (${m.multiplier}Ã—)`).join(", ");
});

/* Evaluate vulnerability: for each candidate (defender = candidate type), compute multipliers for each selected move type */
evaluateVulnBtn.addEventListener("click", ()=>{
  vulnResultDiv.style.display = "none"; vulnResultDiv.innerHTML = "";
  if(!currentCandidates || !currentCandidates.length){
    vulnResultDiv.style.display = "block"; vulnResultDiv.innerHTML = "<div class='note'>No candidates â€” run the 'Find Attackers' step first.</div>";
    return;
  }
  const moves = moveSelects.map(s=>s.value).filter(Boolean);
  if(!moves.length){
    vulnResultDiv.style.display = "block"; vulnResultDiv.innerHTML = "<div class='note'>Select at least one move type (attack type) from the Raid movepool.</div>";
    return;
  }

  // Build table header: Candidate | move1 | move2 | ... | Max
  let html = "<table><thead><tr><th>Candidate (as defender)</th>";
  moves.forEach(m => html += `<th>${escapeHtml(m)}</th>`);
  html += "<th>Max</th></tr></thead><tbody>";

  for(const cand of currentCandidates){
    html += `<tr><td>${escapeHtml(cand)}</td>`;
    let maxv = 0;
    for(const mv of moves){
      // find attackRow for move type (attack type)
      const attackRow = findAttackRow(mv) || findAttackRowByHeaderName(mv); // fallback
      if(!attackRow){
        html += `<td>â€”</td>`;
        continue;
      }
      // index of candidate in header
      const col = defenderColIndex(cand);
      if(col < 1){ html += `<td>â€”</td>`; continue; }
      const val = attackRow[col] || "";
      const num = Number(val);
      const display = (val === "") ? "â€”" : (Number.isNaN(num) ? escapeHtml(val) : num + "Ã—");
      if(!Number.isNaN(num) && num > maxv) maxv = num;
      html += `<td>${escapeHtml(display)}</td>`;
    }
    html += `<td>${maxv>0? (maxv + "Ã—") : "â€”"}</td>`;
    html += "</tr>";
  }

  html += "</tbody></table>";
  vulnResultDiv.innerHTML = html;
  vulnResultDiv.style.display = "block";
});

/* helper: sometimes header includes attack types too; search column headers for an attack-type-like match */
function findAttackRowByHeaderName(name){
  // find header index which equals name and then use corresponding row? Not typical. We'll return null.
  return null;
}

/* Resets */
resetRaidBtn.addEventListener("click", ()=>{ raidType1.value=""; raidType2.value=""; attackCandidatesDiv.innerHTML=""; currentCandidates = []; vulnResultDiv.style.display="none"; vulnResultDiv.innerHTML=""; });
resetMovesBtn.addEventListener("click", ()=>{ moveSelects.forEach(s=> s.value=""); vulnResultDiv.style.display="none"; vulnResultDiv.innerHTML=""; });

/* ---------- helpers ---------- */
function escapeHtml(s){
  if(s === null || s === undefined) return "";
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}
</script>
</body>
</html>
