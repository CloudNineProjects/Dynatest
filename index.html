<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dynamax Helper</title>

<!-- PapaParse for CSV -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root{
    /* tuned HEX colors to match template look more closely */
    --bg-light: #F2FBF6;       /* page background (light mode) */
    --bg-dark:  #0E1417;       /* page background dark */
    --card-start:#28C77D;      /* green start */
    --card-end:  #1AA05A;      /* green end */
    --card-light: linear-gradient(180deg,var(--card-start),var(--card-end));
    --card-dark: linear-gradient(180deg,#12312a,#0b1d17);
    --text-light:#0A0A0A;
    --text-dark:#F5F5F5;
    --accent:#28C77D;
    --muted-light:#444;
    --muted-dark:#CFCFCF;
    --glass: rgba(255,255,255,0.04);
  }

  html,body{
    height:100%;
    margin:0;
    font-family:Inter,system-ui,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    transition: background .25s, color .25s;
  }

  body{
    background:var(--bg-light);
    color:var(--text-light);
  }
  body.dark{
    background:var(--bg-dark);
    color:var(--text-dark);
  }

  /* top-right mode toggle */
  .mode-toggle{
    position:fixed;
    top:14px;
    right:14px;
    z-index:1200;
    background:rgba(255,255,255,0.95);
    color:#000;
    padding:8px 12px;
    border-radius:10px;
    cursor:pointer;
    box-shadow:0 8px 20px rgba(0,0,0,0.12);
    user-select:none;
    font-size:14px;
  }
  body.dark .mode-toggle{
    background:rgba(0,0,0,0.6);
    color:#fff;
  }

  /* Loading screen */
  .loader{
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    gap:18px;
    padding:28px;
    text-align:center;
  }
  .loader img.logo{
    width:200px;
    height:200px;
    border-radius:50%;
    object-fit:cover;
    /* remove border/shadow so it's just the round image */
    border: none;
    box-shadow: none;
  }
  .load-btn{
    display:inline-block;          /* not full width */
    min-width:160px;
    padding:12px 22px;
    border-radius:12px;
    border:none;
    background:var(--accent);
    color:#fff;
    font-weight:600;
    font-size:16px;
    cursor:pointer;
  }
  .load-btn[disabled]{opacity:0.6;cursor:default;}
  .loading-text{font-size:14px;color:var(--muted-light)}

  /* App container - cards stacked vertically */
  .wrap{
    max-width:980px;
    margin:24px auto;
    padding:16px;
    display:flex;
    flex-direction:column;
    gap:18px;
  }

  .card{
    border-radius:14px;
    padding:18px;
    background:var(--card-light);
    color:#fff;
    box-shadow:0 10px 30px rgba(0,0,0,0.12);
    transition: transform .12s ease, box-shadow .12s ease;
  }
  body.dark .card{ background: var(--card-dark); }
  .card:hover{ transform: translateY(-4px); }

  h1{ margin:0 0 12px; font-size:20px; color:inherit; }
  label{ display:block; margin:10px 0 6px; font-weight:600; color:inherit; }

  /* Inputs: selects full width, buttons mostly in controls */
  select{
    width:100%;
    padding:10px 12px;
    border-radius:8px;
    border:1px solid rgba(0,0,0,0.06);
    font-size:15px;
    background:#fff;
    color:#000;
    box-sizing:border-box;
  }
  body.dark select{ background:#000; color:#fff; border:1px solid rgba(255,255,255,0.06); }

  .controls{
    margin-top:10px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .controls button{
    padding:10px 14px;
    border-radius:8px;
    border:none;
    background:#fff;
    color:#000;
    cursor:pointer;
    font-weight:600;
  }
  body.dark .controls button{ background:#111; color:#fff; }

  .results{
    margin-top:12px;
    padding:12px;
    border-radius:10px;
    background:var(--glass);
    color:inherit;
  }
  pre.preserve{ white-space:pre-wrap; margin:0; font-family:inherit; }

  table{ width:100%; border-collapse:collapse; font-size:14px; }
  th,td{ padding:8px; border-bottom:1px solid rgba(255,255,255,0.06); vertical-align:top; }
  th{ position:sticky; top:0; background:rgba(0,0,0,0.08); z-index:2; font-weight:700; }

  .badge{ display:inline-block; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.12); margin:4px 6px 4px 0; }

  /* cell coloring */
  .cell-strong{ background:#b42c2c; color:#fff; font-weight:700; }
  .cell-resist{ background:#206699; color:#fff; }
  .cell-immune{ background:#444; color:#fff; }
  .cell-normal{ background:transparent; color:inherit; }
  .cell-other{ background:rgba(255,255,255,0.03); }

  /* responsive tweaks */
  @media(max-width:640px){
    .loader img.logo{ width:160px; height:160px; }
    .wrap{ padding:12px; }
  }
</style>
</head>
<body>
  <div id="modeToggle" class="mode-toggle">ðŸŒ™ Dark Mode</div>

  <!-- Loading -->
  <div id="loading" class="loader" aria-live="polite">
    <img class="logo" src="https://i.imgur.com/XZcfQzw.png" alt="Dynamax logo">
    <button id="loadBtn" class="load-btn">Load Data</button>
    <div id="loadingText" class="loading-text" style="display:none">Loading...</div>
  </div>

  <!-- App -->
  <div id="app" class="wrap" style="display:none;">

    <!-- Card 1: Dynamax Info -->
    <div class="card" id="card-info">
      <h1>Dynamax Info</h1>
      <label for="infoFilter">Filter (Column A: type)</label>
      <select id="infoFilter"><option value="">-- select --</option></select>
      <div class="controls">
        <button id="infoShow">Show</button>
        <button id="infoReset">Reset</button>
      </div>
      <div id="infoOut" class="results" style="display:none"></div>
    </div>

    <!-- Card 2: Dynamax Database -->
    <div class="card" id="card-db">
      <h1>Dynamax Database</h1>
      <label for="dbFilter">Filter (Column A)</label>
      <select id="dbFilter"><option value="">-- select --</option></select>
      <div class="controls">
        <button id="dbShow">Show</button>
        <button id="dbReset">Reset</button>
      </div>
      <div id="dbOut" class="results" style="display:none"></div>
    </div>

    <!-- Card 4: Attack & Defense (kept before Move as requested) -->
    <div class="card" id="card-attack">
      <h1>Attack Check</h1>
      <label for="atkDef1">Defender 1</label>
      <select id="atkDef1"><option value="">-- select --</option></select>

      <label for="atkDef2">Defender 2 (optional)</label>
      <select id="atkDef2"><option value="">-- select --</option></select>

      <div class="controls">
        <button id="atkShow">Show</button>
        <button id="atkReset">Reset</button>
      </div>
      <div id="atkOut" class="results" style="display:none"></div>

      <hr style="margin:16px 0;border:none;border-top:1px solid rgba(255,255,255,0.06)">

      <h1>Defense Check</h1>
      <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:8px;">
        <select id="def1"><option value="">-- Move 1 --</option></select>
        <select id="def2"><option value="">-- Move 2 --</option></select>
        <select id="def3"><option value="">-- Move 3 --</option></select>
        <select id="def4"><option value="">-- Move 4 --</option></select>
      </div>

      <div class="controls" style="margin-top:8px;">
        <button id="defShow">Show</button>
        <button id="defReset">Reset</button>
      </div>

      <div id="defOut" class="results" style="display:none; overflow-y:auto; max-height:420px;"></div>
    </div>

    <!-- Card 3: Dynamax Move (moved to bottom) -->
    <div class="card" id="card-move">
      <h1>Dynamax Move</h1>
      <label for="moveFilter">Filter (Column A)</label>
      <select id="moveFilter"><option value="">-- select --</option></select>
      <div class="controls">
        <button id="moveShow">Show</button>
        <button id="moveReset">Reset</button>
      </div>
      <div id="moveOut" class="results" style="display:none"></div>
    </div>

  </div>

<script>
/* helpers */
const $ = id => document.getElementById(id);
const escapeHtml = s => s==null?'':String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

/* normalize values to standardized tokens */
function normalizeValue(v){
  if(v==null) return '';
  const s = String(v).trim();
  if(!s) return '';
  if(/^(2|2\.0)$/i.test(s)) return '2';
  if(/^(1|1\.0)$/i.test(s)) return '1';
  if(/^(0\.5|Â½|1\/2)$/i.test(s)) return '0.5';
  if(/^(0|0\.0|immune|x0)$/i.test(s.toLowerCase())) return '0';
  return s;
}
function valueClass(v){
  const n = normalizeValue(v);
  if(n==='2') return 'cell-strong';
  if(n==='1') return 'cell-normal';
  if(n==='0.5') return 'cell-resist';
  if(n==='0') return 'cell-immune';
  return 'cell-other';
}

/* CSV URLs (from your message) */
const URL_INFO   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRKBJf3BXL7kqLIu8WAZCiFIBqNTMVvWCmkRA2kVoC30QskuIRkxwUKJJnrHKh2Y8I18iZ0p068wRD2/pub?output=csv";
const URL_DB     = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRGq_ta_VKuhpNif51aoWSm2XKE04CHREcDqGObDZnBQ0kK3Yo-_Bz7i7u1oP1Xv9pRm0-xN7dDgyiT/pub?output=csv";
const URL_MOVE   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRfBHLwHVULXabVXPztSXOz-36oGnjJFxuHyhgftVYg3Ft_f7VqkVwfpdmQwrfZEXrdjCKnydJBqRHt/pub?output=csv";
const URL_ATTACK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQUYm_GBIYmou5lzjHIeXmz9GlP0d4_z3g6Jxrpof_DvIBFdOh8bL4dNF8v4T2Vn5sseu8zOhRzP74O/pub?output=csv";

/* data containers */
let infoRows=[], infoFields=[];
let dbRows=[], dbFields=[];
let moveRows=[], moveFields=[];
let atkRows=[], atkFields=[];

/* parsing */
function parseCSV(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url,{
      download:true,
      header:true,
      skipEmptyLines:true,
      complete:function(res){
        // trim headers and values
        const fields = (res.meta.fields || []).map(f=>f==null?'':String(f).trim());
        const rows = (res.data || []).map(r=>{
          const out = {};
          for(const k in r){
            const key = (k==null ? '' : String(k).trim());
            out[key] = r[k] == null ? '' : String(r[k]);
          }
          return out;
        });
        resolve({fields, data: rows});
      },
      error: function(err){ reject(err); }
    });
  });
}

/* UI helpers */
function showLoading(msg){ $('loadingText').style.display='block'; $('loadingText').textContent = msg || 'Loading...'; }
function hideLoading(){ $('loadingText').style.display='none'; }

function uniqueFromColumn(rows,col){
  const s = new Set();
  rows.forEach(r=>{
    const v = (r[col]||'').trim();
    if(v) s.add(v);
  });
  return Array.from(s).sort((a,b)=>a.localeCompare(b,'en'));
}

function populateSelect(sel, items, placeholder){
  sel.innerHTML = '';
  const ph = document.createElement('option'); ph.value=''; ph.textContent = placeholder || '-- select --';
  sel.appendChild(ph);
  items.forEach(it=>{
    const o = document.createElement('option'); o.value = it; o.textContent = it;
    sel.appendChild(o);
  });
}

function renderPre(s){ return `<pre class="preserve">${escapeHtml(s||'')}</pre>`; }

function renderTable(rows, fields, cols){
  let html = '<div style="overflow:auto"><table><thead><tr>';
  cols.forEach(c => html += `<th>${escapeHtml(c)}</th>`);
  html += '</tr></thead><tbody>';
  rows.forEach(r=>{
    html += '<tr>';
    cols.forEach(c=>{
      const raw = r[c] || '';
      const cls = valueClass(raw);
      const content = (typeof raw === 'string' && raw.indexOf('\n') !== -1) ? `<pre class="preserve" style="margin:0">${escapeHtml(raw)}</pre>` : escapeHtml(raw);
      html += `<td class="${cls}">${content}</td>`;
    });
    html += '</tr>';
  });
  html += '</tbody></table></div>';
  return html;
}

/* load everything */
function loadAll(){
  $('loadBtn').disabled = true;
  showLoading('Loading sheets...');
  Promise.all([
    parseCSV(URL_INFO).then(r=>{ infoFields = r.fields; infoRows = r.data; }),
    parseCSV(URL_DB).then(r=>{ dbFields = r.fields; dbRows = r.data; }),
    parseCSV(URL_MOVE).then(r=>{ moveFields = r.fields; moveRows = r.data; }),
    parseCSV(URL_ATTACK).then(r=>{ atkFields = r.fields; atkRows = r.data; })
  ]).then(()=>{
    hideLoading();
    $('loading').style.display = 'none';
    $('app').style.display = 'flex';
    populateFilters();
  }).catch(err=>{
    console.error(err);
    $('loadingText').textContent = 'Error loading sheets (check console)';
    $('loadBtn').disabled = false;
  });
}

/* populate selects */
function populateFilters(){
  // Info
  const infoA = infoFields[0] || Object.keys(infoRows[0] || {})[0] || 'A';
  populateSelect($('infoFilter'), uniqueFromColumn(infoRows, infoA), '-- select --');

  // DB
  const dbA = dbFields[0] || Object.keys(dbRows[0] || {})[0] || 'A';
  populateSelect($('dbFilter'), uniqueFromColumn(dbRows, dbA), '-- select --');

  // Move (moved to bottom but still populated)
  const moveA = moveFields[0] || Object.keys(moveRows[0] || {})[0] || 'A';
  populateSelect($('moveFilter'), uniqueFromColumn(moveRows, moveA), '-- select --');

  // Attack - defenders are headers except first
  const defenders = atkFields.slice(1);
  populateSelect($('atkDef1'), defenders, '-- Defender --');
  populateSelect($('atkDef2'), defenders, '-- Defender (optional) --');

  // Defense - moves are row labels (first column)
  const rowLabel = atkFields[0] || Object.keys(atkRows[0] || {})[0] || 'A';
  const moveNames = uniqueFromColumn(atkRows, rowLabel);
  ['def1','def2','def3','def4'].forEach(id=> populateSelect($(id), moveNames, '-- Move --') );
}

/* Card 1: Info show/reset */
$('infoShow').addEventListener('click', ()=>{
  const sel = $('infoFilter').value;
  if(!sel){ alert('Select a filter'); return; }
  const colA = infoFields[0] || Object.keys(infoRows[0] || {})[0];
  const colB = infoFields[1] || Object.keys(infoRows[0] || {})[1];
  const matches = infoRows.filter(r => (r[colA]||'').trim() === sel);
  if(matches.length === 0){ $('infoOut').innerHTML = '<p>No entries.</p>'; $('infoOut').style.display='block'; return; }
  const html = matches.map(m => `<div style="margin-bottom:8px">${renderPre(m[colB]||'')}</div>`).join('');
  $('infoOut').innerHTML = html; $('infoOut').style.display='block';
});
$('infoReset').addEventListener('click', ()=>{
  $('infoFilter').selectedIndex = 0; $('infoOut').style.display='none'; $('infoOut').innerHTML='';
});

/* Card 2: DB */
$('dbShow').addEventListener('click', ()=>{
  const sel = $('dbFilter').value;
  if(!sel){ alert('Select a filter'); return; }
  const colA = dbFields[0] || Object.keys(dbRows[0] || {})[0];
  const matches = dbRows.filter(r => (r[colA]||'').trim() === sel);
  if(matches.length === 0){ $('dbOut').innerHTML = '<p>No entries.</p>'; $('dbOut').style.display='block'; return; }
  const cols = dbFields.slice(1,7); // B..G
  if(cols.length === 0){ $('dbOut').innerHTML = '<p>Columns B-G not found.</p>'; $('dbOut').style.display='block'; return; }
  $('dbOut').innerHTML = renderTable(matches, dbFields, cols); $('dbOut').style.display='block';
});
$('dbReset').addEventListener('click', ()=>{ $('dbFilter').selectedIndex = 0; $('dbOut').style.display='none'; $('dbOut').innerHTML=''; });

/* Card 4: Attack check with corrected logic */
$('atkShow').addEventListener('click', ()=>{
  const sel1 = $('atkDef1').value || '';
  const sel2 = $('atkDef2').value || '';
  if(!sel1 && !sel2){ alert('Select at least one defender'); return; }
  const selected = [sel1, sel2].filter(Boolean);
  const rowLabel = atkFields[0] || Object.keys(atkRows[0] || {})[0];

  const results = [];

  atkRows.forEach(r=>{
    const vals = selected.map(c => normalizeValue(r[c] || ''));
    if(selected.length === 1){
      // single selection: require exactly 2
      if(vals[0] === '2') results.push(r[rowLabel] || '');
    } else {
      // two selections: accept if:
      // - at least one of the two values is '2'
      // AND
      // - the other value is '1' OR '2' (so 2+2 or 2+1)
      const has2 = vals.includes('2');
      const count2 = vals.filter(v => v === '2').length;
      const has1 = vals.includes('1');

      if(has2 && (has1 || count2 >= 2)){
        results.push(r[rowLabel] || '');
      }
    }
  });

  if(results.length === 0){
    $('atkOut').innerHTML = '<p>No results.</p>'; $('atkOut').style.display='block'; return;
  }
  $('atkOut').innerHTML = results.map(x => `<span class="badge">${escapeHtml(x)}</span>`).join(' ');
  $('atkOut').style.display='block';
});
$('atkReset').addEventListener('click', ()=>{
  $('atkDef1').selectedIndex = 0; $('atkDef2').selectedIndex = 0; $('atkOut').style.display='none'; $('atkOut').innerHTML='';
});

/* Defense check: Show (rows A-S), keep vertical scrolling */
$('defShow').addEventListener('click', ()=>{
  const chosen = ['def1','def2','def3','def4'].map(id => $(id).value).filter(Boolean);
  if(chosen.length === 0){ alert('Select at least one move'); return; }
  const rowLabel = atkFields[0] || Object.keys(atkRows[0] || {})[0];
  const matches = atkRows.filter(r => chosen.includes((r[rowLabel]||'').trim()));
  const cols = atkFields.slice(0,19); // A..S
  if(matches.length === 0){ $('defOut').innerHTML = '<p>No rows found.</p>'; $('defOut').style.display='block'; return; }
  $('defOut').innerHTML = renderTable(matches, atkFields, cols); $('defOut').style.display='block';
});
$('defReset').addEventListener('click', ()=>{
  ['def1','def2','def3','def4'].forEach(id => $(id).selectedIndex = 0);
  $('defOut').style.display='none'; $('defOut').innerHTML='';
});

/* Card 3: Dynamax Move (now at bottom) */
$('moveShow').addEventListener('click', ()=>{
  const sel = $('moveFilter').value;
  if(!sel){ alert('Select a filter'); return; }
  const colA = moveFields[0] || Object.keys(moveRows[0] || {})[0];
  const colB = moveFields[1] || Object.keys(moveRows[0] || {})[1];
  const matches = moveRows.filter(r => (r[colA]||'').trim() === sel);
  if(matches.length === 0){ $('moveOut').innerHTML = '<p>No entries.</p>'; $('moveOut').style.display='block'; return; }
  $('moveOut').innerHTML = matches.map(m => renderPre(m[colB]||'')).join('<hr>');
  $('moveOut').style.display='block';
});
$('moveReset').addEventListener('click', ()=>{ $('moveFilter').selectedIndex = 0; $('moveOut').style.display='none'; $('moveOut').innerHTML=''; });

/* Mode toggle */
const modeToggle = $('modeToggle');
function updateToggle(){ modeToggle.textContent = document.body.classList.contains('dark') ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode'; }
modeToggle.addEventListener('click', ()=>{ document.body.classList.toggle('dark'); updateToggle(); });
updateToggle();

/* Load button */
$('loadBtn').addEventListener('click', loadAll);

</script>
</body>
</html>
